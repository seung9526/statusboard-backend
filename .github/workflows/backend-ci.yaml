name: Backend CI/CD

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/statusboard-backend
  INFRA_REPO: seung9526/statusboard-infra
  INFRA_VALUES_PATH: helm/statusboard/values.yaml
  BRANCH: ${{ github.ref_name }}
  TAG_SHA: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      # 1ï¸âƒ£ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2ï¸âƒ£ JDK í™˜ê²½ ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3ï¸âƒ£ gradlew ì‹¤í–‰ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ
      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest .

      # 5ï¸âƒ£ Trivy ì´ë¯¸ì§€ ìŠ¤ìº” (unfixed ë¬´ì‹œ)
      - name: Scan Docker image with Trivy
        run: |
          trivy image --severity CRITICAL --exit-code 1 --ignore-unfixed --format table ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest

      # 6ï¸âƒ£ GHCR ë¡œê·¸ì¸
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ í‘¸ì‹œ
      - name: Push Docker image
        run: docker push ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest

      # 8ï¸âƒ£ infra ë ˆí¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout infra repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.INFRA_REPO }}
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra-repo
          ref: main
          fetch-depth: 0

      # 9ï¸âƒ£ values-dev.yamlì˜ backend.image.tag ì—…ë°ì´íŠ¸
      - name: Update backend image tag in infra values
        working-directory: infra-repo
        run: |
          echo "Updating backend.image.tag to ${BRANCH}-latest (sha: ${TAG_SHA:0:7})"
          if command -v yq >/dev/null 2>&1; then
            yq -i '.backend.image.tag = strenv(BRANCH) + "-latest"' $INFRA_VALUES_PATH
          else
            sed -i 's#^\(\s*tag:\s*\).*$#\1'${BRANCH}'-latest#' $INFRA_VALUES_PATH
          fi
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -b chore/update-backend-image-${BRANCH}-$(echo $TAG_SHA | cut -c1-7)
          git add $INFRA_VALUES_PATH
          git commit -m "chore: update backend image tag to ${BRANCH}-latest (from ${GITHUB_REPOSITORY}@${TAG_SHA})" || echo "No changes"

      # ðŸ”Ÿ infra ë ˆí¬ì— PR ìƒì„±
      - name: Create PR to infra
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra-repo
          branch: chore/update-backend-image-${{ env.BRANCH }}-${{ env.TAG_SHA }}
          title: "chore(infra): BE image -> ${{ env.BRANCH }}-latest"
          commit-message: "chore: BE image tag -> ${{ env.BRANCH }}-latest"
          base: main
          body: |
            Backend Docker image updated by CI/CD.
            - Repo: ${{ github.repository }}
            - Commit: ${{ env.TAG_SHA }}
            - Tag: ${{ env.BRANCH }}-latest
          labels: ci, backend
