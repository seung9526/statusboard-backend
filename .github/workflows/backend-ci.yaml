name: Backend CI/CD

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/statusboard-backend
  INFRA_REPO: seung9526/statusboard-infra
  INFRA_VALUES_PATH: helm/statusboard/values.yaml
  BRANCH: ${{ github.ref_name }}
  TAG_SHA: ${{ github.sha }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      # 1️⃣ 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ JDK 환경 설정
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3️⃣ gradlew 실행권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4️⃣ Docker 이미지 빌드
      - name: Build Docker image
        run: docker build -t ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest .

      # 5️⃣ Trivy 이미지 스캔 (unfixed 무시)
      - name: Scan Docker image with Trivy
        run: |
          trivy image --severity CRITICAL --exit-code 1 --ignore-unfixed --format table ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest

      # 6️⃣ GHCR 로그인
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 7️⃣ Docker 이미지 푸시
      - name: Push Docker image
        run: docker push ${{ env.IMAGE_NAME }}:${{ env.BRANCH }}-latest

      # 8️⃣ infra 레포 체크아웃
      - name: Checkout infra repo
        uses: actions/checkout@v3
        with:
          repository: ${{ env.INFRA_REPO }}
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra-repo
          ref: main
          fetch-depth: 0

      # 9️⃣ values-dev.yaml의 backend.image.tag 업데이트
      - name: Update backend image tag in infra values
        working-directory: infra-repo
        run: |
          echo "Updating backend.image.tag to ${BRANCH}-latest (sha: ${TAG_SHA:0:7})"
          if command -v yq >/dev/null 2>&1; then
            yq -i '.backend.image.tag = strenv(BRANCH) + "-latest"' $INFRA_VALUES_PATH
          else
            sed -i 's#^\(\s*tag:\s*\).*$#\1'${BRANCH}'-latest#' $INFRA_VALUES_PATH
          fi
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -b chore/update-backend-image-${BRANCH}-$(echo $TAG_SHA | cut -c1-7)
          git add $INFRA_VALUES_PATH
          git commit -m "chore: update backend image tag to ${BRANCH}-latest (from ${GITHUB_REPOSITORY}@${TAG_SHA})" || echo "No changes"

      # 🔟 infra 레포에 PR 생성
      - name: Create PR to infra
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.INFRA_REPO_TOKEN }}
          path: infra-repo
          branch: chore/update-backend-image-${{ env.BRANCH }}-${{ env.TAG_SHA }}
          title: "chore(infra): BE image -> ${{ env.BRANCH }}-latest"
          commit-message: "chore: BE image tag -> ${{ env.BRANCH }}-latest"
          base: main
          body: |
            Backend Docker image updated by CI/CD.
            - Repo: ${{ github.repository }}
            - Commit: ${{ env.TAG_SHA }}
            - Tag: ${{ env.BRANCH }}-latest
          labels: ci, backend
